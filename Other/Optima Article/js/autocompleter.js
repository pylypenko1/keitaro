var Observer=new Class({Implements:[Options,Events],options:{periodical:!1,delay:1e3},initialize:function(e,t,i){this.element=document.id(e)||$document.id(e),this.addEvent("onFired",t),this.setOptions(i),this.bound=this.changed.bind(this),this.resume()},changed:function(){var e=this.element.get("value");$equals(this.value,e)||(this.clear(),this.value=e,this.timeout=this.onFired.delay(this.options.delay,this))},setValue:function(e){return this.value=e,this.element.set("value",e),this.clear()},onFired:function(){this.fireEvent("onFired",[this.value,this.element])},clear:function(){return clearTimeout(this.timeout||null),this},pause:function(){return this.timer?clearTimeout(this.timer):this.element.removeEvent("keyup",this.bound),this.clear()},resume:function(){return this.value=this.element.get("value"),this.options.periodical?this.timer=this.changed.periodical(this.options.periodical,this):this.element.addEvent("keyup",this.bound),this}}),$equals=function(e,t){return e==t||JSON.encode(e)==JSON.encode(t)},Autocompleter=new Class({Implements:[Options,Events],options:{minLength:1,markQuery:!0,width:"inherit",maxChoices:10,injectChoice:null,customChoices:null,emptyChoices:null,visibleChoices:!0,className:"autocompleter-choices",zIndex:1e3,delay:400,observerOptions:{},fxOptions:{},autoSubmit:!1,overflow:!1,overflowMargin:25,selectFirst:!1,filter:null,filterCase:!1,filterSubset:!1,forceSelect:!1,selectMode:!0,choicesMatch:null,multiple:!1,separator:", ",separatorSplit:/\s*[,;]\s*/,autoTrim:!1,allowDupes:!1,cache:!0,relative:!1},initialize:function(e,t){this.element=document.id(e),this.setOptions(t),this.build(),this.observer=new Observer(this.element,this.prefetch.bind(this),Object.merge({},{delay:this.options.delay},this.options.observerOptions)),this.queryValue=null,this.options.filter&&(this.filter=this.options.filter.bind(this));var i=this.options.selectMode;this.typeAhead="type-ahead"==i,this.selectMode=!0===i?"selection":i,this.cached=[]},build:function(){document.id(this.options.customChoices)?this.choices=this.options.customChoices:(this.choices=new Element("ul",{class:this.options.className,styles:{zIndex:this.options.zIndex}}).inject(document.body),this.relative=!1,this.options.relative&&(this.choices.inject(this.element,"after"),this.relative=this.element.getOffsetParent()),this.fix=new OverlayFix(this.choices)),this.options.separator.test(this.options.separatorSplit)||(this.options.separatorSplit=this.options.separator),this.fx=this.options.fxOptions?new Fx.Tween(this.choices,Object.merge({},{property:"opacity",link:"cancel",duration:200},this.options.fxOptions)).addEvent("onStart",Chain.prototype.clearChain).set(0):null,this.element.setProperty("autocomplete","off").addEvent(Browser.ie||Browser.safari||Browser.chrome?"keydown":"keypress",this.onCommand.bind(this)).addEvent("click",this.onCommand.bind(this,[!1])).addEvent("focus",this.toggleFocus.pass({bind:this,arguments:!0,delay:100})).addEvent("blur",this.toggleFocus.pass({bind:this,arguments:!1,delay:100}))},destroy:function(){this.fix&&this.fix.destroy(),this.choices=this.selected=this.choices.destroy()},toggleFocus:function(e){this.focussed=e,e||this.hideChoices(!0),this.fireEvent(e?"onFocus":"onBlur",[this.element])},onCommand:function(e){if(!e&&this.focussed)return this.prefetch();if(e&&e.key&&!e.shift)switch(e.key){case"enter":if(this.element.value!=this.opted)return!0;if(this.selected&&this.visible)return this.choiceSelect(this.selected),!!this.options.autoSubmit;break;case"up":case"down":if(!this.prefetch()&&null!==this.queryValue){var t="up"==e.key;this.choiceOver((this.selected||this.choices)[this.selected?t?"getPrevious":"getNext":t?"getLast":"getFirst"](this.options.choicesMatch),!0)}return!1;case"esc":case"tab":this.hideChoices(!0)}return!0},setSelection:function(e){var t=this.selected.inputValue,i=t,s=this.queryValue.length,o=t.length;if(t.substr(0,s).toLowerCase()!=this.queryValue.toLowerCase()&&(s=0),this.options.multiple){var h=this.options.separatorSplit;i=this.element.value,s+=this.queryIndex,o+=this.queryIndex;var n=i.substr(this.queryIndex).split(h,1)[0];if(i=i.substr(0,this.queryIndex)+t+i.substr(this.queryIndex+n.length),e){var r=i.split(this.options.separatorSplit).filter((function(e){return this.test(e)}),/[^\s,]+/);this.options.allowDupes||(r=[].combine(r));var l=this.options.separator;o=(i=r.join(l)+l).length}}this.observer.setValue(i),this.opted=i,(e||"pick"==this.selectMode)&&(s=o),this.element.selectRange(s,o),this.fireEvent("onSelection",[this.element,this.selected,i,t])},showChoices:function(){var e=this.options.choicesMatch,t=this.choices.getFirst(e);if(this.selected=this.selectedValue=null,this.fix){var i=this.element.getCoordinates(this.relative),s=this.options.width||"auto";this.choices.setStyles({left:i.left,top:i.bottom,width:!0===s||"inherit"==s?i.width:s})}if(t){this.visible||(this.visible=!0,this.choices.setStyle("display",""),this.fx&&this.fx.start(1),this.fireEvent("onShow",[this.element,this.choices])),(this.options.selectFirst||this.typeAhead||t.inputValue==this.queryValue)&&this.choiceOver(t,this.typeAhead);var o=this.choices.getChildren(e),h=this.options.maxChoices,n={overflowY:"hidden",height:""};if(this.overflown=!1,o.length>h){var r=o[h-1];n.overflowY="scroll",n.height=r.getCoordinates(this.choices).bottom,this.overflown=!0}if(this.choices.setStyles(n),this.fix.show(),this.options.visibleChoices){var l=document.getScroll(),a=document.getSize(),c=this.choices.getCoordinates();c.right>l.x+a.x&&(l.x=c.right-a.x),c.bottom>l.y+a.y&&(l.y=c.bottom-a.y),window.scrollTo(Math.min(l.x,c.left),Math.min(l.y,c.top))}}},hideChoices:function(e){if(e){var t=this.element.value;this.options.forceSelect&&(t=this.opted),this.options.autoTrim&&(t=t.split(this.options.separatorSplit).filter($arguments(0)).join(this.options.separator)),this.observer.setValue(t)}if(this.visible){this.visible=!1,this.selected&&this.selected.removeClass("autocompleter-selected"),this.observer.clear();var i=function(){this.choices.setStyle("display","none"),this.fix.hide()}.bind(this);this.fx?this.fx.start(0).chain(i):i(),this.fireEvent("onHide",[this.element,this.choices])}},prefetch:function(){var e=this.element.value,t=e;if(this.options.multiple){var i=this.options.separatorSplit,s=e.split(i),o=this.element.getSelectedRange().start,h=e.substr(0,o).split(i),n=h.length-1;o-=h[n].length,t=s[n]}if(t.length<this.options.minLength)this.hideChoices();else if(t===this.queryValue||this.visible&&t==this.selectedValue){if(this.visible)return!1;this.showChoices()}else this.queryValue=t,this.queryIndex=o,this.fetchCached()||this.query();return!0},fetchCached:function(){return!1},update:function(e){this.choices.empty(),this.cached=e;var t=e&&typeOf(e);!t||"array"==t&&!e.length||"hash"==t&&!e.getLength()?(this.options.emptyChoices||this.hideChoices).call(this):(this.options.maxChoices<e.length&&!this.options.overflow&&(e.length=this.options.maxChoices),e.each(this.options.injectChoice||function(e){var t=new Element("li",{html:this.markQueryValue(e)});t.inputValue=e,this.addChoiceEvents(t).inject(this.choices)},this),this.showChoices())},choiceOver:function(e,t){if(e&&e!=this.selected&&(this.selected&&this.selected.removeClass("autocompleter-selected"),this.selected=e.addClass("autocompleter-selected"),this.fireEvent("onSelect",[this.element,this.selected,t]),this.selectMode||(this.opted=this.element.value),t)){if(this.selectedValue=this.selected.inputValue,this.overflown){var i=this.selected.getCoordinates(this.choices),s=this.options.overflowMargin,o=this.choices.scrollTop,h=this.choices.offsetHeight,n=o+h;i.top-s<o&&o?this.choices.scrollTop=Math.max(i.top-s,0):i.bottom+s>n&&(this.choices.scrollTop=Math.min(i.bottom-h+s,n))}this.selectMode&&this.setSelection()}},choiceSelect:function(e){e&&this.choiceOver(e),this.setSelection(!0),this.queryValue=!1,this.hideChoices()},filter:function(e){return(e||this.tokens).filter((function(e){return this.test(e)}),new RegExp((this.options.filterSubset?"":"^")+this.queryValue.escapeRegExp(),this.options.filterCase?"":"i"))},markQueryValue:function(e){return this.options.markQuery&&this.queryValue?e.replace(new RegExp("("+(this.options.filterSubset?"":"^")+this.queryValue.escapeRegExp()+")",this.options.filterCase?"":"i"),'<span class="autocompleter-queried">$1</span>'):e},addChoiceEvents:function(e){return e.addEvents({mouseover:this.choiceOver.bind(this,e),click:this.choiceSelect.bind(this,e)})}}),OverlayFix=new Class({initialize:function(e){Browser.ie&&(this.element=document.id(e),this.relative=this.element.getOffsetParent(),this.fix=new Element("iframe",{frameborder:"0",scrolling:"no",src:"javascript:false;",styles:{position:"absolute",border:"none",display:"none",filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"}}).inject(this.element,"after"))},show:function(){if(this.fix){var e=this.element.getCoordinates(this.relative);delete e.right,delete e.bottom,this.fix.setStyles(Object.append(e,{display:"",zIndex:(this.element.getStyle("zIndex")||1)-1}))}return this},hide:function(){return this.fix&&this.fix.setStyle("display","none"),this},destroy:function(){this.fix&&(this.fix=this.fix.destroy())}});Element.implement({getSelectedRange:function(){if(!Browser.ie)return{start:this.selectionStart,end:this.selectionEnd};var e={start:0,end:0},t=this.getDocument().selection.createRange();if(!t||t.parentElement()!=this)return e;var i=t.duplicate();if("text"==this.type)e.start=0-i.moveStart("character",-1e5),e.end=e.start+t.text.length;else{var s=this.value,o=s.length-s.match(/[\n\r]*$/)[0].length;i.moveToElementText(this),i.setEndPoint("StartToEnd",t),e.end=o-i.text.length,i.setEndPoint("StartToStart",t),e.start=o-i.text.length}return e},selectRange:function(e,t){if(Browser.ie){var i=this.value.substr(e,t-e).replace(/\r/g,"").length;e=this.value.substr(0,e).replace(/\r/g,"").length;var s=this.createTextRange();s.collapse(!0),s.moveEnd("character",e+i),s.moveStart("character",e),s.select()}else this.focus(),this.setSelectionRange(e,t);return this}}),Autocompleter.Base=Autocompleter,Autocompleter.Request=new Class({Extends:Autocompleter,options:{postData:{},ajaxOptions:{},postVar:"value"},query:function(){var e=this.options.postData.unlink||{};e[this.options.postVar]=this.queryValue;var t=document.id(this.options.indicator);t&&t.setStyle("display","");var i=this.options.indicatorClass;i&&this.element.addClass(i),this.fireEvent("onRequest",[this.element,this.request,e,this.queryValue]),this.request.send({data:e})},queryResponse:function(){var e=document.id(this.options.indicator);e&&e.setStyle("display","none");var t=this.options.indicatorClass;return t&&this.element.removeClass(t),this.fireEvent("onComplete",[this.element,this.request])}}),Autocompleter.Request.JSON=new Class({Extends:Autocompleter.Request,initialize:function(e,t,i){this.parent(e,i),this.request=new Request.JSON(Object.merge({},{url:t,link:"cancel"},this.options.ajaxOptions)).addEvent("onComplete",this.queryResponse.bind(this))},queryResponse:function(e){this.parent(),this.update(e)}}),Autocompleter.Request.HTML=new Class({Extends:Autocompleter.Request,initialize:function(e,t,i){this.parent(e,i),this.request=new Request.HTML(Object.merge({},{url:t,link:"cancel",update:this.choices},this.options.ajaxOptions)).addEvent("onComplete",this.queryResponse.bind(this))},queryResponse:function(e,t){this.parent(),t&&t.length?(this.choices.getChildren(this.options.choicesMatch).each(this.options.injectChoice||function(e){var t=e.innerHTML;e.inputValue=t,this.addChoiceEvents(e.set("html",this.markQueryValue(t)))},this),this.showChoices()):this.hideChoices()}}),Autocompleter.Ajax={Base:Autocompleter.Request,Json:Autocompleter.Request.JSON,Xhtml:Autocompleter.Request.HTML};